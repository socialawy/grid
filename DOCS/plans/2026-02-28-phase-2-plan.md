# Phase 2 PLAN

## 1. Ensure tests can find ESM — check/create root package.json with type:module
Create package.json with ES module type at project root

## 2. For browser test — serve the project
cd E:\co\GRID; npx serve . -p 3000
## Then open http://localhost:3000/tests/webgl2-test.html

--

## Phase 2: Persistence & Project

│                                                                                                                   │
│ Context                                                                                                           │
│                                                                                                                   │
│ Phase 0 (format) and Phase 1 (WebGL2 + input + generators + image importer) are COMPLETE. 378/378 tests passing.  │
│ The app is stateless — every reload starts blank. Phase 2 adds persistence so work survives closing the browser.  │
│ Three concentric layers: OPFS (universal), File System Access API (Chrome/Edge pro), and JSON download (fallback  │
│ that already exists).                                                                                             │
│                                                                                                                   │
│ Decisions                                                                                                         │
│                                                                                                                   │
│ - Single .grid file (not folder with assets) — needed for offline phone floor                                     │
│ - Compact mode for OPFS, full pretty-print for downloads                                                          │
│ - Silent auto-save — no status on success, only on failure                                                        │
│ - Dedicated modal for OPFS project browser                                                                        │
│ - Phase 2.3 scoped down — project settings only, multi-sequence UI deferred to Phase 3                            │
│                                                                                                                   │
│ Task Order                                                                                                        │
│                                                                                                                   │
│ 2.4 Serializer (compact mode + migration) ← pure functions, no browser API                                        │
│   ↓                                                                                                               │
│ 2.1 OPFS storage (save/load/list/delete + auto-save) ← core exit criterion                                        │
│   ↓                                                                                                               │
│ 2.2 File System Access API (Chrome/Edge Ctrl+S cascade) ← parallel with 2.3                                       │
│ 2.3 Project settings modal (BPM/key/palette) ← scoped down, UI only                                               │
│   ↓                                                                                                               │
│ 2.5 PWA manifest + service worker ← last, needs stable app                                                        │
│                                                                                                                   │
│ ---                                                                                                               │
│ Task 2.4 — Serializer                                                                                             │
│                                                                                                                   │
│ New file: src/persistence/serializer.js                                                                           │
│                                                                                                                   │
│ Wraps existing serializeGrid/deserializeGrid from grid-core.js, adds compact mode and version migration.          │
│                                                                                                                   │
│ export function compactGrid(grid) → Grid     // strip default density/semantic                                    │
│ export function serializeProject(grid, { compact, pretty }) → string                                              │
│ export function deserializeProject(jsonString) → Grid  // with migration shims                                    │
│ export function validateProject(grid) → { valid, errors[] }                                                       │
│                                                                                                                   │
│ Compact logic: omit density when it equals calcDensity(char), omit semantic when it equals inferSemantic(char).   │
│ Never strip schema-required fields.                                                                               │
│                                                                                                                   │
│ Tests: tests/test-serializer.js (~30 tests, pure Node.js)                                                         │
│ - Compact removes default-value fields, preserves non-defaults                                                    │
│ - Round-trip: deserialize(serialize(grid)) deep-equals original                                                   │
│ - Version migration: v0.0.x → v0.1.0                                                                              │
│ - Invalid JSON throws clear message                                                                               │
│                                                                                                                   │
│ ---                                                                                                               │
│ Task 2.1 — OPFS Storage Layer                                                                                     │
│                                                                                                                   │
│ New file: src/persistence/opfs-store.js                                                                           │
│                                                                                                                   │
│ export function isOpfsAvailable() → boolean                                                                       │
│ export async function listProjects() → ProjectMeta[]                                                              │
│ export async function saveProject(grid, { compact }) → void                                                       │
│ export async function loadProject(projectId) → Grid                                                               │
│ export async function deleteProject(projectId) → void                                                             │
│ export async function projectExists(projectId) → boolean                                                          │
│                                                                                                                   │
│ Storage: grid-projects/ subdirectory in OPFS root. Filename: ${grid.meta.id}.grid.                                │
│                                                                                                                   │
│ listProjects() reads only first 1KB of each file (meta block) for speed.                                          │
│                                                                                                                   │
│ Auto-save: In UI layer (not module), 2-second debounce, called at every mutation point. Silent on success.        │
│                                                                                                                   │
│ Auto-load on startup: Load most recently modified project from OPFS.                                              │
│                                                                                                                   │
│ UI: "Projects" button in header → dedicated modal with project list (name, date, size), load/delete actions.      │
│                                                                                                                   │
│ Tests: tests/test-opfs-store.js (~40 tests, Node.js with in-memory Map mock for OPFS)                             │
│ - save → load round-trip                                                                                          │
│ - listProjects returns correct metadata                                                                           │
│ - deleteProject removes from list                                                                                 │
│ - loadProject('nonexistent') throws                                                                               │
│                                                                                                                   │
│ ---                                                                                                               │
│ Task 2.2 — File System Access API                                                                                 │
│                                                                                                                   │
│ New file: src/persistence/fs-access.js                                                                            │
│                                                                                                                   │
│ export function isFsAccessAvailable() → boolean                                                                   │
│ export async function saveAs(grid, opts) → FileSystemFileHandle | null                                            │
│ export async function saveToHandle(grid, handle, opts) → void                                                     │
│ export async function openFile() → Grid | null                                                                    │
│ export function registerFileHandler(onFileOpen) → void                                                            │
│                                                                                                                   │
│ Ctrl+S cascade:                                                                                                   │
│ 1. If _currentFileHandle exists → saveToHandle() (silent save)                                                    │
│ 2. Else if FSAPI available → saveAs() (native dialog)                                                             │
│ 3. Else → blob download fallback                                                                                  │
│                                                                                                                   │
│ Key binding changes:                                                                                              │
│ - Ctrl+S → saveFile (new cascade)                                                                                 │
│ - Ctrl+Shift+S → export (old download behavior)                                                                   │
│                                                                                                                   │
│ File handler: window.launchQueue registration for opening .grid files from OS.                                    │
│                                                                                                                   │
│ Tests: tests/test-fs-access.js (~20 tests, Node.js with mock picker)                                              │
│                                                                                                                   │
│ ---                                                                                                               │
│ Task 2.3 — Project Settings (scoped down)                                                                         │
│                                                                                                                   │
│ No new source file. UI-only changes to dist/index.html.                                                           │
│                                                                                                                   │
│ Adds a "Project Settings" modal exposing existing schema fields:                                                  │
│ - Project name                                                                                                    │
│ - BPM (number input)                                                                                              │
│ - Scale (chromatic/major/minor/pentatonic select)                                                                 │
│ - Key (C through B select)                                                                                        │
│ - Palette management                                                                                              │
│                                                                                                                   │
│ Key binding: Ctrl+, → projectSettings                                                                             │
│                                                                                                                   │
│ Multi-sequence editing deferred to Phase 3.                                                                       │
│                                                                                                                   │
│ ---                                                                                                               │
│ Task 2.5 — PWA Manifest + Service Worker                                                                          │
│                                                                                                                   │
│ New files:                                                                                                        │
│ - dist/manifest.json — name, icons, start_url, file_handlers                                                      │
│ - dist/sw.js — cache-first for shell (index.html + manifest)                                                      │
│ - dist/icon-192.png, dist/icon-512.png — ASCII-art style icons                                                    │
│                                                                                                                   │
│ index.html additions:                                                                                             │
│ - <link rel="manifest" href="manifest.json">                                                                      │
│ - SW registration in DOMContentLoaded (3 lines)                                                                   │
│                                                                                                                   │
│ Note: PWA features only activate when served from HTTPS/localhost. The file:// offline floor still works without  │
│ SW.                                                                                                               │
│                                                                                                                   │
│ ---                                                                                                               │
│ File Map                                                                                                          │
│                                                                                                                   │
│ src/persistence/           ← NEW directory                                                                        │
│   serializer.js            ← Task 2.4                                                                             │
│   opfs-store.js            ← Task 2.1                                                                             │
│   fs-access.js             ← Task 2.2                                                                             │
│ dist/                                                                                                             │
│   manifest.json            ← Task 2.5                                                                             │
│   sw.js                    ← Task 2.5                                                                             │
│   icon-192.png             ← Task 2.5                                                                             │
│   icon-512.png             ← Task 2.5                                                                             │
│   index.html               ← Modified: inline all new modules + UI                                                │
│ tests/                                                                                                            │
│   test-serializer.js       ← Task 2.4                                                                             │
│   test-opfs-store.js       ← Task 2.1                                                                             │
│   test-fs-access.js        ← Task 2.2                                                                             │
│   run-all.js               ← Modified: add 3 new suites                                                           │
│                                                                                                                   │
│ Critical Existing Files                                                                                           │
│                                                                                                                   │
│ - src/core/grid-core.js — calcDensity(), inferSemantic() needed by compactGrid                                    │
│ - tests/test-input-system.js — mock pattern to follow for OPFS/FSAPI mocks                                        │
│ - tests/run-all.js — register 3 new test suites                                                                   │
│ - dist/index.html — inline new modules + auto-save hooks + project UI                                             │
│                                                                                                                   │
│ Verification                                                                                                      │
│                                                                                                                   │
│ 1. node tests/run-all.js → ~468 tests, 0 failed                                                                   │
│ 2. Open dist/index.html → paint cells → close browser → reopen → project restored                                 │
│ 3. Click "Projects" → see list of saved projects → load/delete works                                              │
│ 4. Ctrl+S in Chrome → native save dialog → save .grid file → Ctrl+S again → silent overwrite                      │
│ 5. Firefox/Safari: Ctrl+S falls back to download, OPFS auto-save still works                                      │
│ 6. Serve from localhost → Chrome installs as PWA → works offline                                                  │
│ 7. Export .grid → open in text editor → human-readable JSON                                                       │
│                                                                                                                   │
│ Exit Criteria                                                                                                     │
│                                                                                                                   │
│ - Create project → close browser → reopen → project intact (Task 2.1)                                             │
│ - Works in Firefox, Safari, Chrome (Task 2.1 OPFS + Task 2.4 JSON fallback)                                       │
│ - PWA installable on Android/desktop (Task 2.5)                                                                   │
│ - .grid files are human-readable in any text editor (Task 2.4 pretty-print)