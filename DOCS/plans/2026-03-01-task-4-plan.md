# Phase 4 â€” The 3D Consumer

## What I'm building:

- `src/consumers/spatial/heightmap.js` â€” grid â†’ heightmap data (pure, zero DOM)
- `src/consumers/spatial/scene-builder.js` â€” Three.js scene from heightmap (browser)
- `tests/test-heightmap.js` â€” Node-compatible tests
- `dist/index.html` â€” ğŸ§Š 3D mode tab added

### Starting with the pure heightmap engine:

- Now the test suite â€” pure Node.js, no DOM, no Three.js

- Two failures â€” both are bugs, not wrong tests. Let me fix them

- Now fix the normal computation. On a flat grid all cells have the same elevation so dx=dy=0, normal = (0,1,0)/1 = (0,1,0). But the test is using boundary cells (x=0 or x=1 at edges of a 2x2 grid), and getElev for out-of-bounds returns 0, creating a slope artifact. The flat-normal test needs an interior cell or the implementation needs to clamp to edge elevation

- 68/68. Now build the index.html 3D mode. I'll create the inline version with the Three.js CDN gate and mode toggle

## What shipped:

- `src/consumers/spatial/heightmap.js` â€” Task 4.1, pure functions, zero DOM, zero Three.js:

- `gridToHeightmap(grid, frameIndex, opts)` â†’ `HeightmapData` with flat cell array (row-major), stats, meta
- Priority chain: `channel.spatial.height` â†’ `density` â†’ `DEFAULT_ELEVATION`; same for material
- `opts.elevationScale`, `opts.flattenBelow`, `opts.invertY` â€” all tested
- `normalizeElevations()` â€” returns new object, no mutation
- `computeNormals()` â€” edge-clamped finite differences â†’ unit-length Float32Array
- `toElevationBuffer()` â€” Float32Array for Three.js displacement maps
- Full material table: solid/void/fluid/emissive/entity/control/boundary with Three.js-ready descriptors
- Universal export (ESM + CJS + `window.HeightmapEngine`)

- `src/consumers/spatial/scene-builder.js` â€” Task 4.2, browser-only, CDN-gated:

- `isThreeAvailable()` guard â€” safe to call before init
- `createSceneBuilder(container, opts)` â†’ builder instance
- InstancedMesh per `(material, color)` group â€” one draw call per variant
- Fluid cells â†’ flat instanced plane at `FLUID_WORLD_HEIGHT`
- Emissive cells â†’ PointLights (capped at `MAX_LIGHTS=8`, brightest-first)
- Manual orbit controls (mouse + touch) â€” no OrbitControls addon needed
- `setCameraPreset('orbit'|'top'|'flyover')`, `destroy()` (full GPU teardown)
- `getScene()` â†’ raw THREE.Scene ready for GLTFExporter (Phase 6)

## `PHASE4-INTEGRATION-PATCH.html`

10 labeled surgical patches to apply to `dist/index.html`: CDN script tag, CSS, HTML, module inlining, app state, the 4 functions (`enter3DMode`, `exit3DMode`, `_rebuild3DScene`, `toggle3DMode`), event wiring, and cleanup.
Deferred: 4.3 VSP bridge â†’ Phase 8. 4.4 glTF export â†’ Phase 6 (export pipeline is the natural home â€” `getScene()` is already the hook).


### Resolved a bug 
- (ReferenceError: clamp is not defined) in the rendering loop, allowing the 3D scene to successfully visualize the procedural cell grid.

- Updated _rebuild3DScene in dist/index.html to pull the active frame from the renderer (renderer ? renderer.current : 0). Now, jumping into 3D mode will properly render the frame you're actually viewing in the 2D grid instead of always resetting to frame 0.

-  UX hint has been added to `enter3DMode()` in `dist/index.html`.
> The 3D button's tooltip will now dynamically show which frame is being rendered if the project has multiple frames, and defaults to just "3D View" if there's only one. 

PS E:\co\GRID> node tests/run-all.js
ğŸš€ GRID Test Runner â€” Starting all test suites...


ğŸ§ª GRID Core Library
==================================================

ğŸ§ª WebGL2 Modules (font-atlas, instance-buffer)
==================================================
=== GRID Core Test Suite ===

âœ… createGrid - basic functionality
âœ… createGrid - with options
âœ… createGrid - invalid dimensions
âœ… createFrame - basic functionality
âœ… createCell - basic functionality
âœ… generateId - UUID v4 format
âœ… setCell - basic functionality
âœ… getCell - basic functionality
âœ… serializeGrid - basic functionality
âœ… deserializeGrid - basic functionality
âœ… validateGrid - valid grid
    Grid creation time: 0.04ms
âœ… performance - grid creation

=== Test Results ===
Passed: 12
Failed: 0
Total: 12
Success Rate: 100.0%

=== parseHexColor ===

âœ… parseHexColor â€” #RRGGBB white
âœ… parseHexColor â€” #RRGGBB black
âœ… parseHexColor â€” #RRGGBB red
âœ… parseHexColor â€” #RRGGBB arbitrary
âœ… parseHexColor â€” #RGB shorthand
âœ… parseHexColor â€” null fallback
âœ… parseHexColor â€” empty string fallback
âœ… parseHexColor â€” invalid format fallback

=== Constants ===

âœ… FLOATS_PER_INSTANCE is 5

=== getBufferByteSize ===

âœ… getBufferByteSize â€” 80x24 (terminal)
âœ… getBufferByteSize â€” 200x100 (standard)
âœ… getBufferByteSize â€” 1000x1000 (max spec)

=== buildInstanceBuffer ===

âœ… buildInstanceBuffer â€” empty frame fills defaults
âœ… buildInstanceBuffer â€” single cell override
âœ… buildInstanceBuffer â€” cell uses default color if none specified
âœ… buildInstanceBuffer â€” auto density for known char
âœ… buildInstanceBuffer â€” out of bounds cells ignored
âœ… buildInstanceBuffer â€” unknown char falls back to defaultIndex
âœ… buildInstanceBuffer â€” row-major order

=== Performance ===

    200Ã—100 (500 cells): 1.96ms
âœ… performance â€” 200Ã—100 buffer build < 10ms
    500Ã—500 (2000 cells): 14.98ms
âœ… performance â€” 500Ã—500 buffer build < 50ms
    1000Ã—1000 (5000 cells): 7.12ms
âœ… performance â€” 1000Ã—1000 buffer build < 200ms

=== Font Atlas ===

â­ï¸  Font Atlas tests â€” No canvas API in Node.js â€” run webgl2-test.html in brrowser

=== Test Results ===
Passed: 22
Failed: 0
Skipped: 1
Total: 22
Success Rate: 100.0%

WebGL2 Modules: 22 passed, 0 failed, 1 skipped

ğŸ§ª Input System (key-bindings + input-system)
==================================================

--- normalizeKey ---
  âœ… plain key
  âœ… ctrl modifier
  âœ… shift modifier
  âœ… ctrl+shift combo
  âœ… meta treated as ctrl

--- createKeyBindings â€” defaults ---
  âœ… Space â†’ playToggle
  âœ… ArrowRight â†’ nextFrame
  âœ… ArrowLeft â†’ prevFrame
  âœ… KeyE â†’ eraserToggle
  âœ… Delete â†’ clearFrame
  âœ… Escape â†’ closeModal
  âœ… ctrl+KeyS â†’ saveFile
  âœ… ctrl+KeyO â†’ import
  âœ… ctrl+KeyN â†’ newProject
  âœ… Digit1 â†’ selectChar:1
  âœ… Digit9 â†’ selectChar:9
  âœ… Unmapped key â†’ null

--- createKeyBindings â€” custom bindings ---
  âœ… custom KeyZ â†’ undo
  âœ… default still active after custom

--- createKeyBindings â€” bind / unbind ---
  âœ… bind() adds new key
  âœ… unbind() removes key
  âœ… bind() overrides default
  âœ… getAll() returns object
  âœ… getAll() reflects overrides

--- createInputSystem â€” cellDown ---
  âœ… cellDown fires on mousedown
  âœ… cellDown coords correct

--- createInputSystem â€” cellMove / cellHover ---
  âœ… no cellMove before drag
  âœ… cellHover on passive mousemove
  âœ… cellMove fires while dragging
  âœ… cellMove coords correct
  âœ… no duplicate cellMove for same cell

--- createInputSystem â€” cellUp ---
  âœ… cellUp fires on window mouseup
  âœ… cellUp has x
  âœ… cellUp has y
  âœ… no cellUp without prior cellDown

--- createInputSystem â€” keyboard actions ---
  âœ… action fires for mapped key
  âœ… playToggle action
  âœ… selectChar payload parsed
  âœ… ctrl+KeyS â†’ saveFile
  âœ… unmapped key fires no action

--- createInputSystem â€” form field suppression ---
  âœ… no actions fired when typing in form fields

--- createInputSystem â€” on() / off() ---
  âœ… off() prevents handler from firing

--- createInputSystem â€” destroy() ---
  âœ… destroy() stops event emission
  âœ… destroy() removes canvas mousedown listener

==================================================
Input System: 44 passed, 0 failed
Input System: 44 passed, 0 failed

ğŸ§ª Image Importer (imageToGrid + rgbToHex)
==================================================

--- rgbToHex ---
  âœ… red
  âœ… green
  âœ… blue
  âœ… black
  âœ… white
  âœ… arbitrary color
  âœ… rounds fractional R
  âœ… clamps out-of-range values

--- DEFAULT_CHAR_RAMP ---
  âœ… DEFAULT_CHAR_RAMP is a string
  âœ… DEFAULT_CHAR_RAMP is non-empty
  âœ… DEFAULT_CHAR_RAMP ends with space (lightest)
  âœ… DEFAULT_CHAR_RAMP starts with @ (darkest)

--- imageToGrid â€” grid structure ---
  âœ… format identifier correct
  âœ… version correct
  âœ… has frames array
  âœ… at least one frame
  âœ… gridWidth = floor(100/10) = 10
  âœ… gridHeight = floor(50/10) = 5
  âœ… has meta.id
  âœ… default project name

--- imageToGrid â€” cell channels ---
  âœ… cell has char
  âœ… cell has hex color
  âœ… density in [0,1]
  âœ… cell has semantic

--- imageToGrid â€” dark image uses dark char ---
  âœ… one cell for 10Ã—10 image with cellSize=10
  âœ… darkest pixel â†’ ramp[0] = '@'
  âœ… black pixel has density â‰ˆ 1

--- imageToGrid â€” white image produces empty frame ---
  âœ… white image yields no cells (space chars skipped)

--- imageToGrid â€” contrast adjustment ---
  âœ… low contrast: valid grid
  âœ… high contrast: valid grid

--- imageToGrid â€” custom charRamp ---
  âœ… custom ramp[0] = X used for dark pixels
  âœ… charset includes custom ramp chars

--- imageToGrid â€” forced dimensions ---
  âœ… gridWidth override respected
  âœ… gridHeight override respected

--- imageToGrid â€” projectName ---
  âœ… projectName set in meta.name

--- imageToGrid â€” error handling ---
  âœ… throws for zero-dimension image

==================================================
Image Importer: 36 passed, 0 failed
Image Importer: 36 passed, 0 failed

ğŸ§ª Generators v2 (10 generators, all 5 channels)
==================================================

--- clamp01 ---
  âœ… clamp01(0) = 0
  âœ… clamp01(1) = 1
  âœ… clamp01(0.5) = 0.5
  âœ… clamp01(-1) = 0
  âœ… clamp01(2) = 1

--- mulberry32 ---
  âœ… same seed produces same first value
  âœ… output in [0, 1)
  âœ… different seed produces different first value
  âœ… output reasonably distributed (30-70 each side in 100 draws)

--- hslToHex ---
  âœ… returns valid hex string
  âœ… hsl(0,1,0.5) = red = #ff0000
  âœ… hsl(120,1,0.5) = green = #00ff00
  âœ… hsl(240,1,0.5) = blue = #0000ff
  âœ… hsl(0,0,1) = white
  âœ… hsl(0,0,0) = black

--- monoFromHex ---
  âœ… dark variant is valid hex
  âœ… light variant is valid hex
  âœ… density=1 produces darker color than density=0
  âœ… dark variant has minimum lightness (â‰¥ ~0.15)

--- resolveColor ---
  âœ… fixed mode returns opts.color unchanged
  âœ… mono mode returns valid hex
  âœ… mono mode modifies lightness (different from base)
  âœ… derived mode returns valid hex
  âœ… default colorMode acts as fixed

--- pickChar ---
  âœ… t=0 â†’ first char
  âœ… tâ‰ˆ1 â†’ last char
  âœ… t=0.5 â†’ middle char
  âœ… t=-1 clamped to 0
  âœ… t=2 clamped to 1
  âœ… empty charset â†’ space

--- buildCell ---
  âœ… x set
  âœ… y set
  âœ… char set
  âœ… color set
  âœ… density set
  âœ… semantic set explicitly
  âœ… channel object present
  âœ… channel.audio present
  âœ… channel.spatial present
  âœ… top row â†’ note 127
  âœ… bottom row â†’ note 0
  âœ… density=1 â†’ velocity 127
  âœ… density=0 â†’ velocity 0
  âœ… spatial.height = density
  âœ… spatial.material = semantic
  âœ… extraChannel merged into channel
  âœ… null semantic â†’ inferred from char (~=fluid)

--- GENERATORS registry ---
  âœ… GENERATORS.spiral is a function
  âœ… GENERATORS.wave is a function
  âœ… GENERATORS.mandala is a function
  âœ… GENERATORS.noise is a function
  âœ… GENERATORS.geometric is a function
  âœ… GENERATORS.rain is a function
  âœ… GENERATORS.gradient is a function
  âœ… GENERATORS.pulse is a function
  âœ… GENERATORS.matrix is a function
  âœ… GENERATORS.terrain is a function
  âœ… exactly 10 generators

--- Generator outputs â€” structure ---
  âœ… spiral: returns an array
  âœ… spiral: produces at least one cell
  âœ… spiral: cell.x in bounds
  âœ… spiral: cell.y in bounds
  âœ… spiral: cell.char is single char
  âœ… spiral: cell.color is valid hex
  âœ… spiral: density in [0,1]
  âœ… spiral: semantic is non-empty string
  âœ… spiral: channel is object
  âœ… spiral: channel.audio present
  âœ… spiral: channel.spatial present
  âœ… spiral: audio.note in MIDI range
  âœ… spiral: audio.velocity in MIDI range
  âœ… spiral: audio.duration = 1
  âœ… spiral: spatial.height in [0,1]
  âœ… spiral: spatial.material is string
  âœ… wave: returns an array
  âœ… wave: produces at least one cell
  âœ… wave: cell.x in bounds
  âœ… wave: cell.y in bounds
  âœ… wave: cell.char is single char
  âœ… wave: cell.color is valid hex
  âœ… wave: density in [0,1]
  âœ… wave: semantic is non-empty string
  âœ… wave: channel is object
  âœ… wave: channel.audio present
  âœ… wave: channel.spatial present
  âœ… wave: audio.note in MIDI range
  âœ… wave: audio.velocity in MIDI range
  âœ… wave: audio.duration = 1
  âœ… wave: spatial.height in [0,1]
  âœ… wave: spatial.material is string
  âœ… mandala: returns an array
  âœ… mandala: produces at least one cell
  âœ… mandala: cell.x in bounds
  âœ… mandala: cell.y in bounds
  âœ… mandala: cell.char is single char
  âœ… mandala: cell.color is valid hex
  âœ… mandala: density in [0,1]
  âœ… mandala: semantic is non-empty string
  âœ… mandala: channel is object
  âœ… mandala: channel.audio present
  âœ… mandala: channel.spatial present
  âœ… mandala: audio.note in MIDI range
  âœ… mandala: audio.velocity in MIDI range
  âœ… mandala: audio.duration = 1
  âœ… mandala: spatial.height in [0,1]
  âœ… mandala: spatial.material is string
  âœ… noise: returns an array
  âœ… noise: produces at least one cell
  âœ… noise: cell.x in bounds
  âœ… noise: cell.y in bounds
  âœ… noise: cell.char is single char
  âœ… noise: cell.color is valid hex
  âœ… noise: density in [0,1]
  âœ… noise: semantic is non-empty string
  âœ… noise: channel is object
  âœ… noise: channel.audio present
  âœ… noise: channel.spatial present
  âœ… noise: audio.note in MIDI range
  âœ… noise: audio.velocity in MIDI range
  âœ… noise: audio.duration = 1
  âœ… noise: spatial.height in [0,1]
  âœ… noise: spatial.material is string
  âœ… geometric: returns an array
  âœ… geometric: produces at least one cell
  âœ… geometric: cell.x in bounds
  âœ… geometric: cell.y in bounds
  âœ… geometric: cell.char is single char
  âœ… geometric: cell.color is valid hex
  âœ… geometric: density in [0,1]
  âœ… geometric: semantic is non-empty string
  âœ… geometric: channel is object
  âœ… geometric: channel.audio present
  âœ… geometric: channel.spatial present
  âœ… geometric: audio.note in MIDI range
  âœ… geometric: audio.velocity in MIDI range
  âœ… geometric: audio.duration = 1
  âœ… geometric: spatial.height in [0,1]
  âœ… geometric: spatial.material is string
  âœ… rain: returns an array
  âœ… rain: produces at least one cell
  âœ… rain: cell.x in bounds
  âœ… rain: cell.y in bounds
  âœ… rain: cell.char is single char
  âœ… rain: cell.color is valid hex
  âœ… rain: density in [0,1]
  âœ… rain: semantic is non-empty string
  âœ… rain: channel is object
  âœ… rain: channel.audio present
  âœ… rain: channel.spatial present
  âœ… rain: audio.note in MIDI range
  âœ… rain: audio.velocity in MIDI range
  âœ… rain: audio.duration = 1
  âœ… rain: spatial.height in [0,1]
  âœ… rain: spatial.material is string
  âœ… gradient: returns an array
  âœ… gradient: produces at least one cell
  âœ… gradient: cell.x in bounds
  âœ… gradient: cell.y in bounds
  âœ… gradient: cell.char is single char
  âœ… gradient: cell.color is valid hex
  âœ… gradient: density in [0,1]
  âœ… gradient: semantic is non-empty string
  âœ… gradient: channel is object
  âœ… gradient: channel.audio present
  âœ… gradient: channel.spatial present
  âœ… gradient: audio.note in MIDI range
  âœ… gradient: audio.velocity in MIDI range
  âœ… gradient: audio.duration = 1
  âœ… gradient: spatial.height in [0,1]
  âœ… gradient: spatial.material is string
  âœ… pulse: returns an array
  âœ… pulse: produces at least one cell
  âœ… pulse: cell.x in bounds
  âœ… pulse: cell.y in bounds
  âœ… pulse: cell.char is single char
  âœ… pulse: cell.color is valid hex
  âœ… pulse: density in [0,1]
  âœ… pulse: semantic is non-empty string
  âœ… pulse: channel is object
  âœ… pulse: channel.audio present
  âœ… pulse: channel.spatial present
  âœ… pulse: audio.note in MIDI range
  âœ… pulse: audio.velocity in MIDI range
  âœ… pulse: audio.duration = 1
  âœ… pulse: spatial.height in [0,1]
  âœ… pulse: spatial.material is string
  âœ… matrix: returns an array
  âœ… matrix: produces at least one cell
  âœ… matrix: cell.x in bounds
  âœ… matrix: cell.y in bounds
  âœ… matrix: cell.char is single char
  âœ… matrix: cell.color is valid hex
  âœ… matrix: density in [0,1]
  âœ… matrix: semantic is non-empty string
  âœ… matrix: channel is object
  âœ… matrix: channel.audio present
  âœ… matrix: channel.spatial present
  âœ… matrix: audio.note in MIDI range
  âœ… matrix: audio.velocity in MIDI range
  âœ… matrix: audio.duration = 1
  âœ… matrix: spatial.height in [0,1]
  âœ… matrix: spatial.material is string
  âœ… terrain: returns an array
  âœ… terrain: produces at least one cell
  âœ… terrain: cell.x in bounds
  âœ… terrain: cell.y in bounds
  âœ… terrain: cell.char is single char
  âœ… terrain: cell.color is valid hex
  âœ… terrain: density in [0,1]
  âœ… terrain: semantic is non-empty string
  âœ… terrain: channel is object
  âœ… terrain: channel.audio present
  âœ… terrain: channel.spatial present
  âœ… terrain: audio.note in MIDI range
  âœ… terrain: audio.velocity in MIDI range
  âœ… terrain: audio.duration = 1
  âœ… terrain: spatial.height in [0,1]
  âœ… terrain: spatial.material is string

--- Generator outputs â€” bounds ---
  âœ… spiral: no out-of-bounds cells
  âœ… wave: no out-of-bounds cells
  âœ… mandala: no out-of-bounds cells
  âœ… noise: no out-of-bounds cells
  âœ… geometric: no out-of-bounds cells
  âœ… rain: no out-of-bounds cells
  âœ… gradient: no out-of-bounds cells
  âœ… pulse: no out-of-bounds cells
  âœ… matrix: no out-of-bounds cells
  âœ… terrain: no out-of-bounds cells

--- Generator outputs â€” sparse (no space chars) ---
  âœ… spiral: no space-char cells (sparse grid)
  âœ… wave: no space-char cells (sparse grid)
  âœ… mandala: no space-char cells (sparse grid)
  âœ… noise: no space-char cells (sparse grid)
  âœ… geometric: no space-char cells (sparse grid)
  âœ… rain: no space-char cells (sparse grid)
  âœ… gradient: no space-char cells (sparse grid)
  âœ… pulse: no space-char cells (sparse grid)
  âœ… matrix: no space-char cells (sparse grid)
  âœ… terrain: no space-char cells (sparse grid)

--- Seeded generators â€” determinism ---
  âœ… spiral: same seed â†’ same cell count
  âœ… spiral: same seed â†’ first cell.x identical
  âœ… spiral: same seed â†’ first cell.char identical
  âœ… wave: same seed â†’ same cell count
  âœ… wave: same seed â†’ first cell.x identical
  âœ… wave: same seed â†’ first cell.char identical
  âœ… mandala: same seed â†’ same cell count
  âœ… mandala: same seed â†’ first cell.x identical
  âœ… mandala: same seed â†’ first cell.char identical
  âœ… noise: same seed â†’ same cell count
  âœ… noise: same seed â†’ first cell.x identical
  âœ… noise: same seed â†’ first cell.char identical
  âœ… geometric: same seed â†’ same cell count
  âœ… geometric: same seed â†’ first cell.x identical
  âœ… geometric: same seed â†’ first cell.char identical
  âœ… rain: same seed â†’ same cell count
  âœ… rain: same seed â†’ first cell.x identical
  âœ… rain: same seed â†’ first cell.char identical
  âœ… gradient: same seed â†’ same cell count
  âœ… gradient: same seed â†’ first cell.x identical
  âœ… gradient: same seed â†’ first cell.char identical
  âœ… pulse: same seed â†’ same cell count
  âœ… pulse: same seed â†’ first cell.x identical
  âœ… pulse: same seed â†’ first cell.char identical
  âœ… matrix: same seed â†’ same cell count
  âœ… matrix: same seed â†’ first cell.x identical
  âœ… matrix: same seed â†’ first cell.char identical
  âœ… terrain: same seed â†’ same cell count
  âœ… terrain: same seed â†’ first cell.x identical
  âœ… terrain: same seed â†’ first cell.char identical

--- colorMode variants ---
  âœ… fixed: all cells use opts.color
  âœ… mono: at least some cells differ from base
  âœ… derived: all valid hex

--- terrain â€” biome semantics ---
  âœ… terrain semantic 'solid' is a valid .grid semantic
  âœ… terrain semantic 'emissive' is a valid .grid semantic
  âœ… terrain semantic 'fluid' is a valid .grid semantic
  âœ… terrain produces â‰¥2 distinct biome zones (got: solid,emissive,fluid)   

--- pulse â€” rings parameter ---
  âœ… pulse generates cells for different ring counts

==================================================
Generators: 276 passed, 0 failed
Generators: 276 passed, 0 failed

ğŸ§ª Serializer (compact, round-trip, migration, validation)
==================================================

--- compactGrid â€” strips default density ---
  PASS: density stripped for # (matches calcDensity)
  PASS: char preserved
  PASS: x preserved
  PASS: y preserved
  PASS: color preserved

--- compactGrid â€” strips default semantic ---
  PASS: semantic stripped for # (matches inferSemantic "solid")

--- compactGrid â€” preserves non-default density ---
  PASS: non-default density 0.99 preserved for @

--- compactGrid â€” preserves non-default semantic ---
  PASS: non-default semantic "fluid" preserved for @

--- compactGrid â€” does not mutate original ---
  PASS: original grid not mutated

--- compactGrid â€” strips empty channel objects ---
  PASS: empty channel object stripped

--- compactGrid â€” preserves non-empty channels ---
  PASS: non-empty channel preserved

--- compactGrid â€” always keeps x, y, char ---
  PASS: x present for cell at (0, 0)
  PASS: y present for cell at (0, 0)
  PASS: char present for cell "#"
  PASS: x present for cell at (1, 0)
  PASS: y present for cell at (1, 0)
  PASS: char present for cell "."
  PASS: x present for cell at (2, 0)
  PASS: y present for cell at (2, 0)
  PASS: char present for cell "@"

--- serializeProject â€” returns valid JSON string ---
  PASS: returns a string
  PASS: parsed JSON has grid identifier

--- serializeProject â€” pretty mode (default) ---
  PASS: pretty mode includes newlines
  PASS: pretty mode includes indentation

--- serializeProject â€” minified mode ---
  PASS: minified has no newlines

--- serializeProject â€” compact mode strips defaults ---
  PASS: compact strips default density
  PASS: compact strips default semantic

--- serializeProject â€” updates meta.modified ---
  PASS: modified is a string
  PASS: modified is not empty

--- serializeProject â€” does not mutate original grid ---
  PASS: original modified unchanged

--- deserializeProject â€” basic round-trip ---
  PASS: format identifier preserved
  PASS: canvas width preserved
  PASS: canvas height preserved
  PASS: frame count preserved
  PASS: cell count preserved

--- deserializeProject â€” round-trip with compact ---
  PASS: density re-inflated from compact
  PASS: semantic re-inflated from compact

--- deserializeProject â€” round-trip preserves non-default values ---        
  PASS: non-default density survives round-trip
  PASS: non-default semantic survives round-trip

--- deserializeProject â€” deep equals on round-trip (non-compact) ---        
  PASS: full round-trip deep-equals (except modified timestamp)

--- deserializeProject â€” invalid JSON throws clear message ---
  PASS: invalid JSON throws SyntaxError with clear message

--- deserializeProject â€” missing format identifier throws ---
  PASS: missing format identifier throws

--- deserializeProject â€” wrong format identifier throws ---
  PASS: wrong format identifier throws

--- deserializeProject â€” non-string argument throws ---
  PASS: non-string argument throws TypeError

--- Version migration â€” v0.0.1 gets project object ---
  PASS: project object added by migration
  PASS: project.bpm defaulted to 120
  PASS: project.scale defaulted

--- Version migration â€” v0.0.1 gets sequences array ---
  PASS: sequences array added by migration
  PASS: sequences defaults to empty array

--- Version migration â€” updates version to 0.1.0 ---
  PASS: version migrated to 0.1.0

--- Version migration â€” adds missing meta fields ---
  PASS: meta.tags added
  PASS: meta.notes added
  PASS: meta.author added

--- Version migration â€” adds missing canvas fields ---
  PASS: canvas.background added
  PASS: canvas.fontFamily added

--- Version migration â€” adds missing frame fields ---
  PASS: frame.layers added
  PASS: frame.duration added
  PASS: frame.label added

--- validateProject â€” valid grid passes ---
  PASS: valid grid passes validation
  PASS: no errors for valid grid

--- validateProject â€” missing project object fails ---
  PASS: missing project is invalid
  PASS: error mentions project

--- validateProject â€” invalid meta.id format fails ---
  PASS: bad UUID is invalid
  PASS: error mentions UUID

--- validateProject â€” valid UUID passes ---
  PASS: valid UUID not flagged

--- validateProject â€” includes grid-core validation errors ---
  PASS: invalid canvas width caught
  PASS: error from grid-core validation

--- validateProject â€” null grid fails ---
  PASS: null grid fails validation

Serializer: 68 passed, 0 failed
Serializer: 68 passed, 0 failed

ğŸ§ª OPFS Store (save, load, delete, list, exists)
==================================================

--- isOpfsAvailable ---
  PASS: returns true when navigator.storage.getDirectory exists
  PASS: returns false when navigator is undefined
  PASS: returns false when navigator.storage is undefined
  PASS: returns false when getDirectory is missing
  PASS: returns false when getDirectory is not a function

--- saveProject â€” basic ---
  PASS: grid-projects directory created
  PASS: grid-projects is a directory
  PASS: file was written
  PASS: entry is a file
  PASS: file has content
  PASS: saved file has grid format identifier
  PASS: saved file has correct id

--- saveProject â€” compact mode (default) ---
  PASS: compact+non-pretty produces single-line JSON

--- saveProject â€” compact: false ---
  PASS: non-compact preserves density
  PASS: non-compact preserves semantic

--- saveProject â€” overwrites existing ---
  PASS: file was overwritten with new data

--- saveProject â€” error on missing meta.id ---
  PASS: throws on null grid
  PASS: throws on grid without meta
  PASS: throws on grid with empty meta

--- loadProject â€” basic ---
  PASS: loaded grid has format identifier
  PASS: loaded grid has correct id
  PASS: loaded grid has correct name
  PASS: loaded grid has one frame
  PASS: loaded grid has one cell
  PASS: cell x preserved
  PASS: cell y preserved
  PASS: cell char preserved
  PASS: cell color preserved

--- loadProject â€” re-inflates compacted cells ---
  PASS: density re-inflated after compact save
  PASS: semantic re-inflated after compact save

--- loadProject â€” not found ---
  PASS: throws when project does not exist

--- loadProject â€” not found (no directory) ---
  PASS: throws when grid-projects directory does not exist

--- deleteProject â€” basic ---
  PASS: project exists before delete
  PASS: project gone after delete

--- deleteProject â€” not found ---
  PASS: throws when deleting nonexistent project

--- deleteProject â€” no directory ---
  PASS: throws when grid-projects directory does not exist

--- projectExists ---
  PASS: returns false for nonexistent project
  PASS: returns true after save
  PASS: returns false after delete

--- projectExists â€” no directory ---
  PASS: returns false when directory missing

--- listProjects â€” empty ---
  PASS: returns empty array when no projects

--- listProjects â€” single project ---
  PASS: returns one project
  PASS: project has correct id
  PASS: project has correct name
  PASS: project has size > 0
  PASS: project has created timestamp
  PASS: project has modified timestamp

--- listProjects â€” multiple projects sorted by modified ---
  PASS: returns two projects
  PASS: projects have different ids

--- listProjects â€” ignores non-.grid files ---
  PASS: ignores non-.grid files
  PASS: only returns .grid files

--- listProjects â€” no directory yet ---
  PASS: returns empty array when directory missing

--- round-trip: save then load preserves data ---
  PASS: round-trip: id preserved
  PASS: round-trip: name preserved
  PASS: round-trip: width preserved
  PASS: round-trip: height preserved
  PASS: round-trip: all cells preserved
  PASS: round-trip: cell 0 char
  PASS: round-trip: cell 0 color
  PASS: round-trip: cell 1 char
  PASS: round-trip: cell 1 semantic

--- round-trip: compact mode strips and re-inflates ---
  PASS: compact strips default density
  PASS: compact strips default semantic
  PASS: load re-inflates density
  PASS: load re-inflates semantic

--- multiple operations â€” CRUD workflow ---
  PASS: three projects after creating three
  PASS: two projects after deleting one
  PASS: deleted project not in list
  PASS: project 1 still loadable
  PASS: project 3 still loadable
  PASS: deleted project cannot be loaded

--- edge cases ---
  PASS: default opts save/load works
  PASS: multiple saves of same project yield one entry

OPFS Store: 73 passed, 0 failed
OPFS Store: 73 passed, 0 failed

ğŸ§ª FS Access API (save, open, cascade, download fallback)
==================================================

--- isFsAccessAvailable ---
  PASS: false when showSaveFilePicker missing
  PASS: true when showSaveFilePicker present
  PASS: false when window is undefined

--- getCurrentHandle / clearCurrentHandle ---
  PASS: handle is null after clear

--- saveAs ---
  PASS: saveAs returns the handle
  PASS: saveAs stores handle as current
  PASS: writable was closed
  PASS: written JSON contains format identifier
  PASS: written JSON contains project name
  PASS: suggestedName is grid.meta.name + .grid
  PASS: saveAs returns null on AbortError
  PASS: handle remains null after cancel
  PASS: saveAs re-throws non-AbortError

--- saveToHandle ---
  PASS: saveToHandle closes writable
  PASS: saveToHandle writes valid JSON
  PASS: saveToHandle throws on null handle
  PASS: compact save closes writable

--- openFile ---
  PASS: openFile returns a grid
  PASS: openFile deserializes name correctly
  PASS: openFile stores handle as current
  PASS: openFile returns null on AbortError
  PASS: openFile re-throws non-AbortError

--- registerFileHandler ---
  PASS: registerFileHandler sets consumer
  PASS: file handler callback was called
  PASS: handler receives correct grid
  PASS: handler stores handle as current
  PASS: handler not called for empty files
  PASS: registerFileHandler is no-op without launchQueue

--- downloadFallback ---
  PASS: downloadFallback clicks a link
  PASS: download filename from grid.meta.name
  PASS: link href is a blob URL
  PASS: fallback name is untitled.grid

--- saveCascade ---
  PASS: cascade silent-saves to existing handle
  PASS: cascade shows saveAs dialog when no handle
  PASS: cascade falls back to download when no FSAPI

FS Access: 35 passed, 0 failed
FS Access: 35 passed, 0 failed

ğŸ§ª Music Mapper (Task 3.1 - grid to music events)
==================================================

ğŸ§ª Synth Engine (Task 3.2 - Web Audio synthesis layer)
==================================================

ğŸ§ª MIDI Output (Task 3.4 - Web MIDI scheduling)
==================================================

midi-output: 39 passed, 0 failed
midi-output: 39 passed, 0 failed

ğŸ§ª Heightmap Engine (Task 4.1 - grid to heightmap conversion)
==================================================

test-heightmap.js: 68 passed, 0 failed

test-heightmap.js: 68 passed, 0 failed

==================================================
ğŸ“Š FINAL RESULTS
==================================================
âœ… Passed: 661
âŒ Failed: 0
â­ï¸  Skipped: 1
â±ï¸  Duration: 182ms

ğŸ‰ ALL TESTS PASSED!