What I'm building:

src/consumers/spatial/heightmap.js â€” grid â†’ heightmap data (pure, zero DOM)
src/consumers/spatial/scene-builder.js â€” Three.js scene from heightmap (browser)
tests/test-heightmap.js â€” Node-compatible tests
dist/index.html â€” ðŸ§Š 3D mode tab added

Let's go:Ran 2 commandsRan 2 commandsCheck for uploaded project filesScriptCheck working directoryScriptDoneNo project files uploaded â€” I'll build the modules from spec. Starting with the pure heightmap engine:Created 2 files, ran a commandCreated 2 files, ran a commandCreate directory structureScriptCreate the heightmap engine - pure functions, zero DOM, zero Three.js dependencyheightmap.jsCreate the Three.js scene builder - browser-only, CDN-gatedscene-builder.jsDoneNow the test suite â€” pure Node.js, no DOM, no Three.js:Created a file, ran a commandCreated a file, ran a commandCreate the heightmap test suite - Node compatible, no DOMtest-heightmap.jsRun the heightmap testsScriptDoneTwo failures â€” both are bugs, not wrong tests. Let me fix them:Ran a command, edited a fileRan a command, edited a fileDebug the two failuresScriptFix 1: absent cells (no cell in map) should count as void, not solidheightmap.js+5-3DoneNow fix the normal computation. On a flat grid all cells have the same elevation so dx=dy=0, normal = (0,1,0)/1 = (0,1,0). But the test is using boundary cells (x=0 or x=1 at edges of a 2x2 grid), and getElev for out-of-bounds returns 0, creating a slope artifact. The flat-normal test needs an interior cell or the implementation needs to clamp to edge elevation:Edited a file, ran a commandEdited a file, ran a commandFix 2: use edge clamping for normals so border cells use their own elevation for out-of-bounds neighborsheightmap.js+5-4Run tests again after fixesScriptDone68/68. Now build the index.html 3D mode. I'll create the inline version with the Three.js CDN gate and mode toggle:Create a standalone demo of the 3D mode integration for review - shows the exact code patterns to inline into dist/index.htmlCreate a standalone demo of the 3D mode integration for review - shows the exact code patterns to inline into dist/index.htmlCreate a standalone demo of the 3D mode integration for review - shows the exact code patterns to inline into dist/index.htmlPHASE4-INTEGRATION-PATCH.htmlDoneNow copy all files to outputs:Ran a command, read a fileRan a command, read a fileCopy all outputsScriptPresented 4 filesDone68/68 tests, 0 failures. Here's what shipped:

src/consumers/spatial/heightmap.js â€” Task 4.1, pure functions, zero DOM, zero Three.js:

gridToHeightmap(grid, frameIndex, opts) â†’ HeightmapData with flat cell array (row-major), stats, meta
Priority chain: channel.spatial.height â†’ density â†’ DEFAULT_ELEVATION; same for material
opts.elevationScale, opts.flattenBelow, opts.invertY â€” all tested
normalizeElevations() â€” returns new object, no mutation
computeNormals() â€” edge-clamped finite differences â†’ unit-length Float32Array
toElevationBuffer() â€” Float32Array for Three.js displacement maps
Full material table: solid/void/fluid/emissive/entity/control/boundary with Three.js-ready descriptors
Universal export (ESM + CJS + window.HeightmapEngine)

src/consumers/spatial/scene-builder.js â€” Task 4.2, browser-only, CDN-gated:

isThreeAvailable() guard â€” safe to call before init
createSceneBuilder(container, opts) â†’ builder instance
InstancedMesh per (material, color) group â€” one draw call per variant
Fluid cells â†’ flat instanced plane at FLUID_WORLD_HEIGHT
Emissive cells â†’ PointLights (capped at MAX_LIGHTS=8, brightest-first)
Manual orbit controls (mouse + touch) â€” no OrbitControls addon needed
setCameraPreset('orbit'|'top'|'flyover'), destroy() (full GPU teardown)
getScene() â†’ raw THREE.Scene ready for GLTFExporter (Phase 6)

PHASE4-INTEGRATION-PATCH.html â€” 10 labeled surgical patches to apply to dist/index.html: CDN script tag, CSS, HTML, module inlining, app state, the 4 functions (enter3DMode, exit3DMode, _rebuild3DScene, toggle3DMode), event wiring, and cleanup.
Deferred: 4.3 VSP bridge â†’ Phase 8. 4.4 glTF export â†’ Phase 6 (export pipeline is the natural home â€” getScene() is already the hook)