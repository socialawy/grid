# Task 3.6 Design — Music UI Integration

**Date**: 2026-03-01
**Phase**: 3 — The Music Consumer
**Status**: Approved

---

## Goal

Wire `synth-engine.js` and `music-mapper.js` into `dist/index.html` so the user can hear the grid play. Grid columns = time steps, rows = pitch, density = velocity, color = instrument channel.

---

## Approach

Inline both music modules into the `<script>` block (stripping `export` keywords). No new source files. No module system changes. Single HTML file remains self-contained.

Test infrastructure is untouched — test files keep their `import` statements pointing at `src/consumers/music/*.js`.

---

## Changes to `dist/index.html`

### 1. Two new inline blocks

**Block 1 — `music-mapper`** (~98 lines):
Strip `export` from: `SCALES`, `NOTE_NAMES`, `midiToFrequency`, `midiToName`, `columnToTime`, `rowToNote`, `colorToChannel`, `cellToNoteEvent`, `frameToNoteEvents`. Remove the module-level `import` line (not needed — globals).

**Block 2 — `synth-engine`** (~487 lines):
Strip `export` from: `INSTRUMENTS`, `createNoiseBuffer`, `_resetNoiseBuffer`, `applyADSR`, `playTonalNote`, `playDrum`, `limitPolyphony`, `createSynthEngine`. Remove the `import` line at the top.

### 2. App state additions

```js
let playbackMode = 'frames';   // 'frames' | 'music'
let audioCtx = null;           // lazy-created on first music play (requires user gesture)
let synth = null;              // lazy: createSynthEngine(audioCtx)
```

### 3. `setPlayheadColumn(col)` added to `createRenderer()`

- Private `let _playheadCol = -1;`
- `render()` calls `renderPlayhead()` at end if `_playheadCol >= 0`
- `renderPlayhead()` draws `rgba(0,255,136,0.25)` rect over `x = _playheadCol * cellW`, full canvas height, width `cellW`
- `setPlayheadColumn(col)` sets `_playheadCol = col` and calls `render()`
- Add `setPlayheadColumn` to the returned object

### 4. Toolbar mode toggle button

Add one button next to existing `◀ ▶ Play ▶ ⏹` cluster:

```html
<button id="modeToggleBtn" onclick="togglePlaybackMode()" class="small">Music</button>
```

`togglePlaybackMode()`:
- Stops whichever mode is currently playing
- Flips `playbackMode`
- Updates button text/active class
- Updates status bar

### 5. Transport dispatch

`togglePlayback()` and `stopPlayback()` gain a mode check at the top:

```js
function togglePlayback() {
  if (playbackMode === 'music') { toggleMusicPlayback(); return; }
  // existing frame animation logic unchanged
}

function stopPlayback() {
  if (playbackMode === 'music') { stopMusicPlayback(); return; }
  // existing frame stop logic unchanged
}
```

Space key continues to call `togglePlayback()` via the existing action system — no changes needed there.

### 6. Music transport functions

```js
function keyToMidi(key) {
  const map = { C:60,'C#':61,D:62,'D#':63,E:64,F:65,'F#':66,G:67,'G#':68,A:69,'A#':70,B:71 };
  return map[key] ?? 60;
}

function toggleMusicPlayback() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    synth = createSynthEngine(audioCtx);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();

  if (synth.isPlaying) {
    synth.pause();
    document.getElementById('playBtn').textContent = '▶ Play';
    return;
  }

  synth.play(grid, renderer.current, {
    bpm:         grid.project.bpm || 120,
    scale:       grid.project.scale || 'chromatic',
    rootNote:    keyToMidi(grid.project.key || 'C'),
    subdivision: 4,
    loop:        true,
    onColumnChange(col) { renderer.setPlayheadColumn(col); },
  });
  document.getElementById('playBtn').textContent = '⏸ Pause';
  setStatus(`Playing — ${grid.project.bpm || 120} BPM, ${grid.project.scale || 'chromatic'}`);
}

function stopMusicPlayback() {
  if (synth) synth.stop();
  renderer.setPlayheadColumn(-1);
  document.getElementById('playBtn').textContent = '▶ Play';
  setStatus('Stopped');
}
```

### 7. Cleanup on new project / grid load

In `loadGridIntoApp()` and `createNewProject()`, add before loading new grid:

```js
if (synth) { synth.stop(); synth = null; }
if (audioCtx) { audioCtx.close(); audioCtx = null; }
renderer.setPlayheadColumn(-1);
```

---

## What Does NOT Change

- `src/consumers/music/music-mapper.js` — untouched
- `src/consumers/music/synth-engine.js` — untouched
- All test files — untouched
- Existing frame animation path — fully preserved, only active when `playbackMode === 'frames'`
- BPM/scale/key UI — already in Project Settings modal from Phase 2; no new controls needed

---

## Scope Boundary

Music mode plays the **current frame only** on loop. Frame-chain (arrangement mode, playing through all frames sequentially) is a Phase 8 feature.

---

## Exit Criteria

Open `dist/index.html`. Click "Music" mode toggle. Press Space or ▶. The grid plays — columns advance as a step sequencer, a translucent green bar tracks the current column. BPM and scale come from Project Settings. Stop clears the playhead. Switch back to Frames mode — frame animation works as before. `node tests/run-all.js` stays green (no test changes).
